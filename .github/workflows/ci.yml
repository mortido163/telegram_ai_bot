name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ - Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð±Ð°Ñ€ÑŒÐµÑ€
  fast-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Security and quality checks
      run: |
        echo "ðŸ”’ Running security and quality checks..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
        pip install safety bandit mypy
        safety check -r requirements.txt || true
        bandit -r bot/ || true
        mypy bot/ || true
        
    - name: Run fast unit tests
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key" 
        REDIS_HOST: "dummy"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "âš¡ Running fast unit tests (no external dependencies)..."
        
        # Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ CI Ñ pytest
        python -m pytest tests/test_integration_ci.py -v --tb=short
        
        # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
        python tests/test_imports.py
        
    - name: Validate project structure
      run: |
        echo "ðŸ“ Validating project structure..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        required_files=(
          "bot/reminders.py"
          "bot/request_limiter.py" 
          "handlers/reminders.py"
          "tests/test_integration_ci.py"
          "tests/test_ai_reminders.py"
          "tests/test_request_limiter.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
    - name: Check for secrets and configuration
      run: |
        echo "ðŸ” Checking for secrets..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð² ÐºÐ¾Ð´Ðµ
        if grep -r "sk-[a-zA-Z0-9]" . \
          --exclude-dir={.git,.venv,.pytest_cache,__pycache__} \
          --exclude={*.md,*.yml,*.yaml} \
          -l; then
          echo "âŒ OpenAI API keys found in code"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .gitignore
        if [ -f .gitignore ] && grep -q "\.env" .gitignore; then
          echo "âœ… .env files are properly ignored"
        else
          echo "âš ï¸ .env files might not be ignored"
        fi

  # Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
  component-tests:
    runs-on: ubuntu-latest
    needs: fast-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test request limiter thoroughly
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "dummy"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸ”’ Testing request limiter comprehensively..."
        
        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ñ‚ÐµÐ»Ñ Ñ pytest
        python -m pytest tests/test_request_limiter.py -v --tb=short
        
    - name: Test image encoding and processing
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "dummy"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸ–¼ï¸ Testing image encoding/decoding and Telegram integration..."
        
        # Ð¢ÐµÑÑ‚Ñ‹ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ AI ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
        python -m pytest tests/test_image_encoding.py::TestImageEncoding -v --tb=short
        
        # Ð¢ÐµÑÑ‚Ñ‹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ ÐºÐ°Ðº Ð² Telegram Ð±Ð¾Ñ‚Ðµ
        python -m pytest tests/test_image_encoding.py::TestTelegramImageHandling -v --tb=short
        
        # Ð¢ÐµÑÑ‚Ñ‹ Ñ‚Ð¸Ð¿Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ… Telegram API
        python -m pytest tests/test_image_encoding.py::TestTelegramAPIDataTypes -v --tb=short
        
    - name: Test FSM states and handlers
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "dummy"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸŽ­ Testing FSM states and handlers..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ FSM
        python -c "
        try:
            from bot.states import ReminderStates, EditReminderStates
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ AI-Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹
            required_states = [
                'waiting_for_type',
                'waiting_for_ai_prompt', 
                'waiting_for_ai_role',
                'confirmation'
            ]
            
            for state_name in required_states:
                state = getattr(ReminderStates, state_name, None)
                if state is None:
                    raise ValueError(f'Missing state: {state_name}')
            
            print('âœ… All FSM states are available')
        except Exception as e:
            print(f'âŒ FSM states test failed: {e}')
            exit(1)
        "
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð²
        python -c "
        try:
            from handlers import ai, reminders, settings, base
            print('âœ… All handlers import correctly')
        except Exception as e:
            print(f'âŒ Handlers import failed: {e}')
            exit(1)
        "
        
    - name: Test configuration and constants
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "dummy"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "âš™ï¸ Testing configuration and constants..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚
        python -c "
        try:
            from bot.constants import BUTTON_TEXTS
            from config import Config
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð´Ð»Ñ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹
            if 'reminders' in BUTTON_TEXTS:
                reminder_buttons = BUTTON_TEXTS['reminders']
                print('âœ… Reminder buttons are configured')
            else:
                print('âš ï¸ No reminder buttons found')
            
            print('âœ… Configuration and constants are valid')
        except Exception as e:
            print(f'âŒ Configuration test failed: {e}')
            exit(1)
        "

  # ÐŸÐ¾Ð»Ð½Ð¾Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ñ Redis
  integration-tests:
    runs-on: ubuntu-latest
    needs: [fast-checks, component-tests]
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run full integration tests
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "localhost"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸ”„ Running full integration tests with Redis..."
        
        # Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Redis
        sleep 2
        
        # ÐŸÐ¾Ð»Ð½Ð¾Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ñ pytest
        python -m pytest tests/test_ai_reminders.py -v --tb=short
        
        # Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
        python -m pytest tests/test_image_encoding.py::TestImageEncodingIntegration -v --tb=short
        
    - name: Test system integration and performance
      env:
        OPENAI_API_KEY: "test_key"
        TELEGRAM_TOKEN: "test_token"
        DEEPSEEK_API_KEY: "test_key"
        REDIS_HOST: "localhost"
        REDIS_PORT: "6379"
        REDIS_DB: "0"
        LOG_LEVEL: "INFO"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ï¿½ Testing system integration and performance..."
        
        # Ð¢ÐµÑÑ‚ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
        python -c "
        import asyncio
        import time
        import sys
        
        async def test_full_integration():
            try:
                # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð²ÑÐµÑ… Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
                from bot.ai_client import AIClient
                from bot.cache import CacheManager
                from bot.reminders import ReminderManager
                from bot.request_limiter import RequestLimiter
                
                print('âœ… All components imported successfully')
                
                # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÐ¼Ð¸
                cache_manager = CacheManager()
                request_limiter = RequestLimiter()
                ai_client = AIClient()
                
                # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ²ÑÐ·ÐµÐ¹
                ai_client.set_request_limiter(request_limiter)
                reminder_manager = ReminderManager(cache_manager, None, ai_client)
                
                print('âœ… All components created and connected')
                
                # Ð¢ÐµÑÑ‚ Ð¶Ð¸Ð·Ð½ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ†Ð¸ÐºÐ»Ð°
                await request_limiter.start()
                
                # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
                start_time = time.time()
                for i in range(10):
                    await request_limiter.acquire_request_lock(i, 'test')
                    await request_limiter.release_request_lock(i)
                end_time = time.time()
                
                print(f'âœ… Performance test: 10 operations in {end_time - start_time:.3f}s')
                
                await request_limiter.stop()
                
                print('âœ… Full integration test completed successfully')
                return True
                
            except Exception as e:
                print(f'âŒ Integration test failed: {e}')
                import traceback
                traceback.print_exc()
                return False
        
        success = asyncio.run(test_full_integration())
        if not success:
            sys.exit(1)
        "

  # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
  final-validation:
    runs-on: ubuntu-latest
    needs: [fast-checks, component-tests, integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate project completeness
      run: |
        echo "ï¿½ Final project validation..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÑÐµÑ… ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        critical_files=(
          "README.md"
          "requirements.txt"
          "pyproject.toml"
          ".env.example"
          "Dockerfile"
          "docker-compose.yml"
          "config.py"
          "main.py"
          "bot/reminders.py"
          "bot/request_limiter.py"
          "bot/ai_client.py"
          "bot/cache.py"
          "handlers/reminders.py"
          "tests/test_integration_ci.py"
          "tests/test_ai_reminders.py"
          "tests/test_request_limiter.py"
          "tests/test_image_encoding.py"
        )
        
        missing_files=()
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file MISSING"
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "ðŸ’¥ Critical files are missing!"
          exit 1
        else
          echo "ðŸŽ‰ All critical files are present!"
        fi
        
    - name: Generate test summary
      run: |
        echo "ðŸ“Š Test Summary:"
        echo "âœ… Fast unit tests (no dependencies) - pytest"
        echo "âœ… Component-specific tests - pytest"  
        echo "âœ… Image encoding/decoding tests - pytest"
        echo "âœ… Full integration tests with Redis - pytest"
        echo "âœ… Performance validation"
        echo "âœ… Security and quality checks"
        echo "âœ… Project structure validation"
        echo ""
        echo "ðŸ§ª Testing Framework:"
        echo "  - pytest >= 8.0.0 for test execution"
        echo "  - pytest-asyncio for async test support"
        echo "  - Structured test organization (unit/integration)"
        echo "  - PIL/Pillow for image processing tests"
        echo ""
        echo "ðŸŽ¯ After refactoring:"
        echo "  - Eliminated test duplication"
        echo "  - Clear separation: unit vs integration tests"
        echo "  - Optimized CI pipeline performance"
        echo "  - Improved test maintainability"
        echo "  - Added Moscow timezone support"
        echo "  - Added comprehensive image processing tests"
        echo "  - Added Telegram API data type validation"
        echo ""
        echo "ðŸš€ Ready for production deployment!" 